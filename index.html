<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Base Game</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Telegram SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Web3 Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/index.umd.min.js"></script>
    <script type="module">
        import { createWeb3Modal, defaultWagmiConfig } from 'https://esm.sh/@web3modal/wagmi'
        import { mainnet, base } from 'https://esm.sh/@wagmi/core/chains'
        import { reconnect, watchAccount, getAccount, disconnect } from 'https://esm.sh/@wagmi/core'

        const projectId = '353fba8f0fe5aa0112595912f7ade9b4';
        const metadata = {
            name: 'Base',
            description: 'The Ultimate Basil Game',
            url: window.location.origin,
            icons: ['https://avatars.githubusercontent.com/u/37784886']
        }

        const chains = [base, mainnet]
        const config = defaultWagmiConfig({ chains, projectId, metadata })
        const modal = createWeb3Modal({ wagmiConfig: config, projectId, chains, themeMode: 'light', enableAnalytics: false })

        reconnect(config);
        window.openConnectModal = () => modal.open();
        window.watchWalletAccount = watchAccount;
        window.getWalletAccount = getAccount;
        window.configWagmi = config;
    </script>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide-react"></script>
    
    <style>
        @keyframes leaf-float {
            0% { transform: translateY(0) rotate(0deg) scale(1.2); opacity: 1; }
            100% { transform: translateY(-80px) rotate(45deg) scale(0); opacity: 0; }
        }
        .animate-leaf-float { animation: leaf-float 0.6s ease-out forwards; }
        * { -webkit-tap-highlight-color: transparent; user-select: none; }
        body, html { height: 100%; overflow: hidden; position: fixed; width: 100%; }
        #root { height: 100%; }
    </style>
</head>
<body class="bg-[#F9FBF9]">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- CONFIG ---
        const MY_WALLET_ADDRESS = "0x0000000000000000000000000000000000000000"; // –ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ô
        const USDC_BASE_ADDRESS = "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913";

        const firebaseConfig = {
            apiKey: "AIzaSyC6Z4GKCna_zTSaSzZNz1nmzPlRAYFKmUw",
            authDomain: "baselike-2c62f.firebaseapp.com",
            projectId: "baselike-2c62f",
            storageBucket: "baselike-2c62f.firebasestorage.app",
            messagingSenderId: "139844632636",
            appId: "1:139844632636:web:7e98c8bfbfcaf6f91fc339",
            measurementId: "G-YHRKG63SQ7"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const appId = 'base-game-v1';

        const Icon = ({ name, size = 20, className = "", color = "currentColor" }) => {
          const pascalName = name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('');
          const IconComponent = window.lucideReact ? window.lucideReact[pascalName] : null;
          return IconComponent ? <IconComponent size={size} color={color} className={className} /> : null;
        };

        const App = () => {
          const [points, setPoints] = useState(() => Number(localStorage.getItem('b_p')) || 0);
          const [dailyRate, setDailyRate] = useState(() => Number(localStorage.getItem('b_dr')) || 1);
          const [autoWaterLevel, setAutoWaterLevel] = useState(() => Number(localStorage.getItem('b_wl')) || 0);
          const [isKing, setIsKing] = useState(() => localStorage.getItem('b_k') === 'true');
          const [multiplier, setMultiplier] = useState(() => Number(localStorage.getItem('b_m')) || 1);
          const [lastClickTime, setLastClickTime] = useState(() => Number(localStorage.getItem('b_lc')) || 0);
          const [elixirExpire, setElixirExpire] = useState(() => Number(localStorage.getItem('b_ee')) || 0);
          const [gardenerExpire, setGardenerExpire] = useState(() => Number(localStorage.getItem('b_ge')) || 0);
          const [currentTime, setCurrentTime] = useState(Date.now());
          
          const [activeTab, setActiveTab] = useState('game');
          const [particles, setParticles] = useState([]);
          const [modal, setModal] = useState({ show: false, title: '', message: '', type: 'info', onConfirm: null });
          const [tgUser, setTgUser] = useState(null);
          const [walletAddress, setWalletAddress] = useState(null);
          const [realLeaders, setRealLeaders] = useState([]);
          const [isPendingTx, setIsPendingTx] = useState(false);

          const isElixirActive = elixirExpire > currentTime;
          const isGardenerActive = gardenerExpire > currentTime;
          const timeLeftMs = Math.max(0, (lastClickTime + 86400000) - currentTime);
          const canHarvest = timeLeftMs === 0;

          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
          useEffect(() => {
            auth.signInAnonymously().catch(console.error);
            if (window.Telegram?.WebApp) {
              const webapp = window.Telegram.WebApp;
              webapp.ready();
              webapp.expand();
              setTgUser(webapp.initDataUnsafe?.user);
            }
          }, []);

          // –û–±–ª–∞—á–Ω—ã–π –¢–æ–ø (Firebase)
          useEffect(() => {
            const leaderboardRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('leaderboard');
            const unsubscribe = leaderboardRef.onSnapshot((snapshot) => {
              const players = [];
              snapshot.forEach(doc => players.push(doc.data()));
              setRealLeaders(players.sort((a, b) => b.points - a.points).slice(0, 50));
            });

            const sync = async () => {
              if (tgUser) {
                await leaderboardRef.doc(tgUser.id.toString()).set({
                  id: tgUser.id,
                  name: tgUser.first_name || "User",
                  points: Math.floor(points),
                  isKing,
                  address: walletAddress || ""
                }, { merge: true });
              }
            };
            const syncInterval = setInterval(sync, 45000); // –†–µ–∂–µ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –Ω–∞–≥—Ä—É–∑–∫–∏
            return () => { unsubscribe(); clearInterval(syncInterval); };
          }, [tgUser, points, isKing, walletAddress]);

          useEffect(() => {
            const timer = setInterval(() => setCurrentTime(Date.now()), 1000);
            const wTimer = setInterval(() => {
                if (window.getWalletAccount) {
                    const acc = window.getWalletAccount(window.configWagmi);
                    setWalletAddress(acc?.address || null);
                }
            }, 2000);
            return () => { clearInterval(timer); clearInterval(wTimer); };
          }, []);

          // –ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥
          useEffect(() => {
            const totalDaily = (dailyRate + (autoWaterLevel * 2)) * multiplier * (isKing ? 1.5 : 1) * (isElixirActive ? 2 : 1);
            const interval = setInterval(() => setPoints(p => p + (totalDaily / 86400)), 1000);
            return () => clearInterval(interval);
          }, [dailyRate, autoWaterLevel, multiplier, isKing, isElixirActive]);

          // –ê–≤—Ç–æ-—Å–∞–¥–æ–≤–Ω–∏–∫
          useEffect(() => {
            if (isGardenerActive && canHarvest) performHarvest(false);
          }, [currentTime, isGardenerActive, canHarvest]);

          useEffect(() => {
            localStorage.setItem('b_p', points);
            localStorage.setItem('b_dr', dailyRate);
            localStorage.setItem('b_wl', autoWaterLevel);
            localStorage.setItem('b_lc', lastClickTime);
            localStorage.setItem('b_k', isKing);
            localStorage.setItem('b_m', multiplier);
            localStorage.setItem('b_ee', elixirExpire);
            localStorage.setItem('b_ge', gardenerExpire);
          }, [points, dailyRate, autoWaterLevel, lastClickTime, isKing, multiplier, elixirExpire, gardenerExpire]);

          const performHarvest = (isManual, e = null) => {
            const reward = (dailyRate + (autoWaterLevel * 2)) * multiplier * (isKing ? 1.5 : 1) * (isElixirActive ? 2 : 1);
            setPoints(p => p + reward);
            setLastClickTime(Date.now());
            const id = Date.now();
            setParticles(prev => [...prev, { id, x: e?.clientX || window.innerWidth/2, y: e?.clientY || window.innerHeight/2 }]);
            setTimeout(() => setParticles(ps => ps.filter(p => p.id !== id)), 600);
            if (isManual && window.Telegram?.WebApp) window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');
          };

          const handlePurchase = async (type, mode) => {
            const catalog = {
              fertilizer: { leaf: 50, donor: 0.5, title: '–£–¥–æ–±—Ä–µ–Ω–∏–µ' },
              elixir: { leaf: 30, donor: 0.2, title: '–≠–ª–∏–∫—Å–∏—Ä' },
              gardener: { leaf: 40, donor: 0.25, title: '–°–∞–¥–æ–≤–Ω–∏–∫' },
              king: { leaf: null, donor: 1.0, title: 'King' },
              reset: { donor: 0.3, title: '–°–±—Ä–æ—Å' }
            };
            const item = catalog[type];
            const cost = mode === 'leaf' ? item.leaf : item.donor;
            
            if (mode === 'donor' && !walletAddress) return setModal({ show: true, title: 'Wallet!', message: '–ü–æ–¥–∫–ª—é—á–∏ –∫–æ—à–µ–ª–µ–∫.', type: 'info' });
            if (mode === 'leaf' && (item.leaf === null || points < cost)) return setModal({ show: true, title: '–ú–∞–ª–æ üåø', message: '–ù—É–∂–Ω–æ –±–æ–ª—å—à–µ –ª–∏—Å—Ç—å–µ–≤!', type: 'info' });

            setModal({ show: true, title: '–ö—É–ø–∏—Ç—å?', message: `${item.title} –∑–∞ ${cost} ${mode==='leaf'?'üåø':'USDC'}?`, type: 'confirm', onConfirm: async () => {
              if (mode === 'leaf') {
                setPoints(p => p - cost);
                applyEffect(type);
                setModal({ show: false });
              } else {
                const success = await executeCryptoPayment(cost);
                if (success) { applyEffect(type); setModal({ show: true, title: '–£—Å–ø–µ—Ö!', message: '–ë—É—Å—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.', type: 'info' }); }
              }
            }});
          };

          const applyEffect = (t) => {
            if (t === 'fertilizer') setDailyRate(r => r + 1);
            if (t === 'elixir') setElixirExpire(Date.now() + (3 * 86400000));
            if (t === 'gardener') setGardenerExpire(Date.now() + (7 * 86400000));
            if (t === 'king') setIsKing(true);
            if (t === 'reset') setLastClickTime(0);
          };

          const executeCryptoPayment = async (amt) => {
            try {
              setIsPendingTx(true);
              const provider = new ethers.BrowserProvider(window.ethereum);
              const signer = await provider.getSigner();
              const abi = ["function transfer(address to, uint256 amount) public returns (bool)"];
              const contract = new ethers.Contract(USDC_BASE_ADDRESS, abi, signer);
              const tx = await contract.transfer(MY_WALLET_ADDRESS, ethers.parseUnits(amt.toString(), 6));
              await tx.wait();
              setIsPendingTx(false);
              return true;
            } catch (e) { setIsPendingTx(false); return false; }
          };

          return (
            <div className="h-full flex flex-col items-center overflow-hidden">
              {modal.show && (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm text-center">
                  <div className="bg-white rounded-[24px] p-6 w-full max-w-xs shadow-2xl">
                    <h3 className="font-black text-lg mb-2 uppercase">{modal.title}</h3>
                    <p className="text-xs text-slate-500 mb-6">{modal.message}</p>
                    <div className="flex flex-col gap-2">
                      {isPendingTx ? <div className="py-2 animate-spin self-center"><Icon name="loader-2" size={32} /></div> : 
                        (modal.type === 'confirm' ? (
                          <><button onClick={modal.onConfirm} className="w-full py-4 rounded-xl bg-blue-600 text-white font-black uppercase text-xs">–î–ê</button>
                          <button onClick={() => setModal({ show: false })} className="w-full py-2 text-slate-400 font-bold text-[10px]">–ù–ï–¢</button></>
                        ) : <button onClick={() => setModal({ show: false })} className="w-full py-4 rounded-xl bg-slate-900 text-white font-black uppercase text-xs">–û–ö</button>)
                      }
                    </div>
                  </div>
                </div>
              )}

              {/* Header - –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π */}
              <header className="w-full max-w-md bg-white/80 backdrop-blur-md border-b p-3 flex justify-between items-center sticky top-0 z-40">
                <div className="flex items-center gap-2">
                    <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white text-xs font-black shadow-sm">B</div>
                    <span className="font-black text-lg tracking-tighter">Base</span>
                    <button onClick={() => window.openConnectModal()} className={`text-[9px] font-black px-3 py-1.5 rounded-full border transition-all ${walletAddress ? 'bg-blue-50 text-blue-600' : 'bg-blue-600 text-white'}`}>
                        {walletAddress ? `${walletAddress.substring(0,4)}...` : 'WALLET'}
                    </button>
                </div>
                <div className="bg-green-50 px-3 py-1 rounded-full flex items-center gap-1.5 border border-green-100">
                   <Icon name="leaf" size={14} className="text-green-600" />
                   <span className="text-sm font-black text-green-800">{Math.floor(points)}</span>
                </div>
              </header>

              <main className="flex-1 w-full max-w-md flex flex-col justify-between py-2 overflow-hidden">
                {activeTab === 'game' && (
                  <div className="flex-1 flex flex-col justify-around items-center px-4">
                    <div className="text-center">
                        <div className="text-6xl font-black tracking-tighter text-slate-900 mb-1">{Math.floor(points).toLocaleString()}</div>
                        {isKing && <div className="bg-yellow-400 text-white px-2 py-0.5 rounded-full text-[8px] font-black uppercase inline-block">King Mode x1.5</div>}
                    </div>
                    
                    <div className="relative flex items-center justify-center">
                        <div className={`absolute inset-0 rounded-full blur-[60px] transition-all duration-1000 ${canHarvest ? 'bg-green-400/30' : 'bg-blue-400/10'}`}></div>
                        <img src="basil.png" alt="Basil" onClick={() => canHarvest && performHarvest(true)} className={`w-[220px] h-[220px] object-contain transition-all duration-75 active:scale-90 ${canHarvest && !isGardenerActive ? 'cursor-pointer' : 'grayscale-[0.3] opacity-60'}`} onError={(e) => e.target.src = 'https://cdn-icons-png.flaticon.com/512/888/888063.png'} />
                        {isGardenerActive && <div className="absolute top-2 right-2 bg-blue-600 text-white p-2 rounded-full border-2 border-white animate-bounce shadow-lg"><Icon name="bot" size={20} /></div>}
                        {!canHarvest && !isGardenerActive && <div className="absolute inset-0 flex items-center justify-center"><Icon name="clock" size={48} className="text-blue-500/50" /></div>}
                    </div>

                    <div className="w-full max-w-[280px] flex flex-col gap-2">
                        {canHarvest && !isGardenerActive ? (
                          <button onClick={(e) => performHarvest(true, e)} className="w-full bg-green-500 text-white font-black py-5 rounded-2xl shadow-lg animate-pulse text-lg uppercase">–°–û–ë–†–ê–¢–¨ üåø</button>
                        ) : (
                          <div className="flex flex-col gap-2 w-full">
                              <div className="bg-white border p-3 rounded-2xl text-center">
                                  <p className="text-[9px] font-black text-slate-400 uppercase tracking-widest">{isGardenerActive ? '–ê–≤—Ç–æ-—Å–∞–¥–æ–≤–Ω–∏–∫ –Ω–∞ —Å–º–µ–Ω–µ' : '–ë–∞–∑–∏–ª–∏–∫ —Å–æ–∑—Ä–µ–≤–∞–µ—Ç'}</p>
                                  <div className="text-3xl font-mono font-black text-blue-600 tracking-tighter">
                                      {Math.floor(timeLeftMs/3600000)}:{Math.floor((timeLeftMs%3600000)/60000).toString().padStart(2,'0')}:{Math.floor((timeLeftMs%60000)/1000).toString().padStart(2,'0')}
                                  </div>
                              </div>
                              <button onClick={() => handlePurchase('reset', 'donor')} className="w-full py-3 rounded-xl border-b-2 bg-blue-50 text-blue-600 border-blue-200 text-[10px] font-black uppercase flex items-center justify-center gap-2">
                                  <Icon name="zap" size={14} /> –°–±—Ä–æ—Å–∏—Ç—å —Ç–∞–π–º–µ—Ä ($0.30)
                              </button>
                          </div>
                        )}
                    </div>
                  </div>
                )}

                {activeTab === 'shop' && (
                  <div className="flex-1 overflow-y-auto px-4 py-2 space-y-2">
                    <h2 className="text-xl font-black uppercase mb-3 text-red-500 px-2 flex items-center gap-2"><Icon name="shopping-cart" /> –ú–∞—Ä–∫–µ—Ç</h2>
                    {[{ id:'fertilizer', t:'–£–¥–æ–±—Ä–µ–Ω–∏–µ', d:'+1 üåø/—Å—É—Ç –Ω–∞–≤—Å–µ–≥–¥–∞', l:50, c:0.5, i:'star' },
                      { id:'elixir', t:'–≠–ª–∏–∫—Å–∏—Ä', d:'x2 –¥–æ—Ö–æ–¥ (3 –¥–Ω—è)', l:30, c:0.2, i:'zap' },
                      { id:'gardener', t:'–°–∞–¥–æ–≤–Ω–∏–∫', d:'–ê–≤—Ç–æ-—Å–±–æ—Ä (1 –Ω–µ–¥–µ–ª—è)', l:40, c:0.25, i:'bot' }
                    ].map(i => (
                        <div key={i.id} className="bg-white border border-slate-100 p-3 rounded-2xl flex items-center justify-between gap-3 shadow-sm">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-slate-50 rounded-xl flex items-center justify-center"><Icon name={i.i} size={20} color="#3b82f6" /></div>
                                <div><h4 className="font-black text-xs uppercase">{i.t}</h4><p className="text-[9px] text-slate-400 font-bold">{i.d}</p></div>
                            </div>
                            <div className="flex flex-col gap-1">
                                <button onClick={() => handlePurchase(i.id, 'leaf')} className="bg-green-50 text-green-700 px-3 py-1.5 rounded-lg text-[10px] font-black">{i.l} üåø</button>
                                <button onClick={() => handlePurchase(i.id, 'donor')} className="bg-blue-50 text-blue-700 px-3 py-1.5 rounded-lg text-[10px] font-black">${i.c}</button>
                            </div>
                        </div>
                    ))}
                    <div className="bg-gradient-to-r from-yellow-400 to-orange-500 p-4 rounded-2xl text-white shadow-lg">
                        <div className="flex justify-between items-center">
                            <div>
                                <h3 className="font-black text-xs uppercase italic flex items-center gap-1"><Icon name="crown" size={14}/> King Mode</h3>
                                <p className="text-[9px] font-bold opacity-90">x1.5 –¥–æ—Ö–æ–¥ –Ω–∞–≤—Å–µ–≥–¥–∞</p>
                            </div>
                            <button onClick={() => handlePurchase('king', 'donor')} className="bg-white text-orange-600 px-4 py-2 rounded-xl font-black text-[10px] uppercase shadow-md">BUY $1</button>
                        </div>
                    </div>
                  </div>
                )}
                
                {activeTab === 'leaderboard' && (
                  <div className="flex-1 overflow-y-auto px-4 py-2">
                    <div className="bg-slate-900 rounded-2xl p-4 text-white mb-3 flex items-center justify-between shadow-xl">
                      <div><h2 className="text-sm font-black uppercase italic tracking-wider text-yellow-400">The Top</h2><p className="text-[9px] opacity-60">Total Farmers: {realLeaders.length}</p></div>
                      <div className="text-right"><p className="text-[8px] opacity-60 uppercase font-black">Prize Pool</p><p className="text-lg font-black text-green-400">150 $</p></div>
                    </div>
                    <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                      {realLeaders.map((l, i) => (
                        <div key={i} className={`flex justify-between p-3 border-b last:border-0 items-center ${l.id === tgUser?.id ? 'bg-blue-50' : ''}`}>
                           <div className="flex items-center gap-3">
                             <span className="text-[10px] font-black text-slate-300 w-4">{i+1}</span>
                             <div className="flex flex-col">
                                <span className={`font-black text-xs ${l.isKing ? 'text-yellow-600' : 'text-slate-800'}`}>{l.name} {l.isKing && 'üëë'}</span>
                                <span className="text-[9px] text-slate-400 font-bold">{Math.floor(l.points).toLocaleString()} üåø</span>
                             </div>
                           </div>
                           <span className="text-[9px] font-black text-blue-600 bg-blue-50 px-2 py-1 rounded-lg">FARMER</span>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </main>

              <nav className="w-full max-w-md bg-white border-t pt-3 pb-10 px-3 flex justify-around shadow-[0_-10px_30px_rgba(0,0,0,0.02)] z-40">
                <button onClick={() => setActiveTab('game')} className={`flex flex-col items-center gap-1 transition-all ${activeTab==='game'?'text-blue-600 scale-110 font-black':'text-slate-300'}`}><Icon name="leaf" size={24}/><span className="text-[9px] font-black uppercase">–ò–≥—Ä–∞</span></button>
                <button onClick={() => setActiveTab('shop')} className={`flex flex-col items-center gap-1 transition-all ${activeTab==='shop'?'text-blue-600 scale-110 font-black':'text-slate-300'}`}><Icon name="shopping-cart" size={24}/><span className="text-[9px] font-black uppercase">–ú–∞–≥–∞–∑–∏–Ω</span></button>
                <button onClick={() => setActiveTab('leaderboard')} className={`flex flex-col items-center gap-1 transition-all ${activeTab==='leaderboard'?'text-blue-600 scale-110 font-black':'text-slate-300'}`}><Icon name="trophy" size={24}/><span className="text-[9px] font-black uppercase tracking-tighter">–¢–æ–ø</span></button>
              </nav>

              {particles.map(p => <div key={p.id} className="fixed pointer-events-none z-[60] text-4xl animate-leaf-float opacity-80" style={{ left: p.x - 20, top: p.y - 20 }}>üåø</div>)}
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
